{"version":3,"sources":["etgenderpaygap.js"],"names":["$","$form","$userInputs","html","$button","prop","on","handleCalculateButton","append","$result","hide","$companyInput","find","$bonusInput","validateForm","$salaryInput","$hints","hintIndex","selectedCompany","hints","hintCount","debounce","isSaving","show","ajax","url","dataType","method","type","data","company","id","salary","val","bonus","then","console","log","r","empty","paygap_salary","lifetimeLoss","lifetimeLossTotal","count","fail","jqxhr","textStatus","error","alert","valid","parseInt","selectCompany","name","highlightCompany","removeClass","eq","addClass","handleKeyUp","e","keyCode","length","window","clearTimeout","replace","setTimeout","getMatches","getJSON","done","json","matches","createHints","err","$ul","forEach","hint","i","$li","text","fadeIn","fadeOut","jQuery"],"mappings":"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","file":"etgenderpaygap.js","sourcesContent":["(($)=>$(()=>{\n  const $form = $('.etgpg');\n\n  $userInputs = $('<div/>');\n\n  $userInputs.html(`\n    <div class=\"etgpg__field\">\n      <label for=\"etgpg__salary\">Salary</label>\n      <div class=\"etgpg__input\"><input id=\"etgpg__salary\" name=\"salary\" type=\"number\" /></div>\n    </div>\n\n    <div class=\"etgpg__field\">\n      <label for=\"etgpg__bonus\">Bonus (optional)</label>\n      <div class=\"etgpg__input\"><input id=\"etgpg__bonus\" name=\"bonus\" type=\"number\" /></div>\n    </div>\n\n    <div class=\"etgpg__field etgpg__field--company\">\n      <label for=\"etgpg__company\">Company</label>\n      <div class=\"etgpg__input\">\n        <input id=\"etgpg__company\" name=\"company\" />\n        <div class=\"etgpg__hints\"></div>\n      </div>\n    </div>\n\n  `);\n  const $button = $('<button>Calculate</button>').prop('disabled', true).on('click', handleCalculateButton);\n  $userInputs.append($button);\n  $form.append($userInputs);\n\n  const $result = $('<div class=\"etgpg__result\">Loading...</div>').hide();\n  $form.append($result);\n\n  const $companyInput = $form.find('input[name=\"company\"]');\n  const $bonusInput = $form.find('input[name=\"bonus\"]').on('input', validateForm);\n  const $salaryInput = $form.find('input[name=\"salary\"]').on('input', validateForm);\n  const $hints = $form.find('.etgpg__hints');\n  var hintIndex = -1;\n  var selectedCompany = false;\n  var hints = [];\n  var hintCount = 0;\n  var debounce = false;\n  var isSaving = false;\n\n  function handleCalculateButton() {\n    $userInputs.hide();\n    $result.show();\n\n    // Log at the server.\n    $.ajax({\n      url: '/etgenderpaygap/submit',\n      dataType: 'json',\n      method: 'POST', // In case they upgrade to jQuery 1.9\n      type: 'POST', // for jQuery 1.8\n      data: {\n        company: selectedCompany.id,\n        salary: $salaryInput.val(),\n        bonus: $bonusInput.val(),\n      },\n    })\n    .then(r => {\n      console.log(r);\n      $result.empty();\n      $result.append(\n          (\n            (r.paygap_salary > 0)\n            ? `Based on the gender pay gap at <span>${r.company}</span>`\n            : `We could not calculate a gender pay gap at your company, but based on the national average`\n          )\n        + ` the lifetime loss of income for someone at your pay is\n        <div class=\"etgpg__loss\">${r.lifetimeLoss}</div>\n        If you think this is bad, please <a href=\"#\" class=\"etgpg__button\">Sign the petition</a>\n        A total lifetime loss of ${r.lifetimeLossTotal} has been calculated from ${r.count} women using this tool.`\n      );\n    })\n    .fail((jqxhr, textStatus, error) => {\n      $userInputs.show();\n      $result.hide();\n      alert(\"Sorry, something went wrong, please try again.\");\n    });\n\n  }\n  function validateForm() {\n    valid = (!!selectedCompany) && parseInt($salaryInput.val()) > 0;\n    $button.prop('disabled', !valid);\n  }\n  function selectCompany() {\n    console.log(\"selectCompany\", hintIndex, hints[hintIndex]);\n    $companyInput.val(hints[hintIndex].name);\n    selectedCompany = hints[hintIndex];\n    $hints.hide();\n    validateForm();\n  }\n  function highlightCompany() {\n    $hints.find('li.highlighted').removeClass('highlighted');\n    if (hintIndex>-1) {\n      $hints.find('li').eq(hintIndex).addClass('highlighted');\n    }\n  }\n  function handleKeyUp(e) {\n    if (e.keyCode == 13) {\n      if (hintIndex < 0) {\n        // Cannot submit.\n\n      }\n      else {\n        selectCompany();\n        // Select hint.\n        // @todo trigger save.\n        // @todo update lifetime loss.\n      }\n    }\n    else if (e.keyCode == 38) {\n      hintIndex--;\n      if (hintIndex <0) {\n        hintIndex = hints.length - 1;\n      }\n      highlightCompany();\n    }\n    else if (e.keyCode == 40) {\n      hintIndex++;\n      if (hintIndex >= hints.length) {\n        hintIndex--;\n      }\n      highlightCompany();\n    }\n    else {\n      if (debounce) {\n        window.clearTimeout(debounce);\n        debounce = false;\n      }\n      if ($companyInput.val().replace(/^\\s*(.*?)\\s*$/, '$1')) {\n        debounce = window.setTimeout(getMatches, 150);\n      }\n      else {\n        hints = [];\n        hintIndex = -1;\n        highlightCompany();\n      }\n    }\n  }\n  function getMatches() {\n    $.getJSON('/etgenderpaygap/matches', { company: $companyInput.val() })\n    .done(json => {\n      console.log(\"matches\", json);\n      hints = json.matches;\n      hintCount = json.count;\n      createHints();\n    })\n    .fail((jqxhr, textStatus, error) => {\n      var err = textStatus + \", \" + error;\n      console.log( \"Request Failed: \" + err );\n    });\n  }\n  function createHints() {\n    if (hintCount > 0) {\n      const $ul = $('<ul/>');\n\n      hints.forEach((hint, i) => {\n        const $li = $('<li/>')\n          .text(hint.name);\n        $li.on('click', e => { console.log(\"hintIndex set to \", i); hintIndex = i; highlightCompany(); selectCompany(); });\n        $ul.append($li);\n      });\n      hintIndex = 0;\n      $hints.empty().append($ul);\n      $hints.fadeIn('fast');\n    }\n    else {\n      hintIndex = -1;\n      $hints.empty();\n    }\n    highlightCompany();\n  }\n\n  $companyInput\n    .on('keyup', handleKeyUp)\n    .on('blur', e => $hints.fadeOut('fast'));\n\n\n}))(jQuery);\n"]}