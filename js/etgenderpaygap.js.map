{"version":3,"sources":["etgenderpaygap.js"],"names":["$","$form","$userInputs","html","$button","prop","on","handleCalculateButton","append","$result","hide","$companyInput","find","$salaryInput","validateSalary","$bonusInput","validateBonus","$hints","hintIndex","selectedCompany","hints","hintCount","debounce","isSaving","css","height","show","ajax","url","dataType","method","type","data","company","id","salary","val","bonus","then","console","log","r","empty","paygap_salary","lifetimeLoss","lifetimeLossTotal","count","fail","jqxhr","textStatus","error","alert","parseAsNumber","v","optional","replace","match","parseInt","validateForm","showMessages","valid","text","selectCompany","name","highlightCompany","removeClass","eq","addClass","handleKeyUp","e","keyCode","length","window","clearTimeout","setTimeout","getMatches","getJSON","done","json","matches","createHints","err","$ul","forEach","hint","i","$li","fadeIn","fadeOut","jQuery"],"mappings":"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","file":"etgenderpaygap.js","sourcesContent":["(($)=>$(()=>{\n  const $form = $('.etgpg');\n\n  $userInputs = $('<div/>');\n\n  $userInputs.html(`\n    <div class=\"etgpg__field\">\n      <label for=\"etgpg__salary\">Salary</label>\n      <div class=\"etgpg__input\"><input id=\"etgpg__salary\" name=\"salary\" type=\"text\" /><span class=\"etgpg__salary_msg\"></span></div>\n    </div>\n\n    <div class=\"etgpg__field\">\n      <label for=\"etgpg__bonus\">Bonus (optional)</label>\n      <div class=\"etgpg__input\"><input id=\"etgpg__bonus\" name=\"bonus\" type=\"text\" /><span class=\"etgpg__bonus_msg\"></span></div>\n    </div>\n\n    <div class=\"etgpg__field etgpg__field--company\">\n      <label for=\"etgpg__company\">Company</label>\n      <div class=\"etgpg__input\">\n        <input id=\"etgpg__company\" name=\"company\" />\n        <div class=\"etgpg__hints\"></div>\n      </div>\n    </div>\n\n  `);\n  const $button = $('<button>Calculate</button>').prop('disabled', true).on('click', handleCalculateButton);\n  $userInputs.append($button);\n  $form.append($userInputs);\n\n  const $result = $('<div class=\"etgpg__result\">Loading...</div>').hide();\n  $form.append($result);\n\n  const $companyInput = $form.find('input[name=\"company\"]');\n  const $salaryInput = $form.find('input[name=\"salary\"]')\n    .on('input', validateSalary);\n  const $bonusInput = $form.find('input[name=\"bonus\"]')\n    .on('input', validateBonus);\n  const $hints = $form.find('.etgpg__hints');\n  var hintIndex = -1;\n  var selectedCompany = false;\n  var hints = [];\n  var hintCount = 0;\n  var debounce = false;\n  var isSaving = false;\n\n  function handleCalculateButton() {\n    // Set the min height of the result box to that of the input box to minimise screen flashing.\n    $result.css('min-height', $userInputs.height() + 'px').show();\n    $userInputs.hide();\n\n    // Log at the server.\n    $.ajax({\n      url: '/etgenderpaygap/submit',\n      dataType: 'json',\n      method: 'POST', // In case they upgrade to jQuery 1.9\n      type: 'POST', // for jQuery 1.8\n      data: {\n        company: selectedCompany.id,\n        salary: $salaryInput.val(),\n        bonus: $bonusInput.val(),\n      },\n    })\n    .then(r => {\n      console.log(r);\n      $result.empty();\n      $result.append(\n          (\n            (r.paygap_salary > 0)\n            ? `Based on the gender pay gap at <span>${r.company}</span>`\n            : `We could not calculate a gender pay gap at your company, but based on the national average`\n          )\n        + ` the lifetime loss of income for someone at your pay is\n        <div class=\"etgpg__loss\">${r.lifetimeLoss}</div>\n        If you think this is bad, please <br /><div class=\"etgpg__centre\"><a href=\"#\" class=\"etgpg__button\">Sign the petition</a></div><br/>\n        A total lifetime loss of ${r.lifetimeLossTotal} has been calculated from ${r.count} women using this tool.`\n      );\n    })\n    .fail((jqxhr, textStatus, error) => {\n      $userInputs.show();\n      $result.hide();\n      alert(\"Sorry, something went wrong, please try again.\");\n    });\n\n  }\n  function parseAsNumber(v, optional) {\n    // Trim.\n    v = v.replace(/^\\s*(.*?)\\s*$/, '$1');\n    if (v==='' && optional) {\n      return;\n    }\n    v = v.replace(/[Â£,]/g, '');\n    if (v.match(/^[1-9]\\d\\d\\d+$/)) {\n      return parseInt(v);\n    }\n    // Error\n    return false;\n  }\n  function validateForm(showMessages) {\n    valid = true;\n    valid &= validateSalary();\n    valid &= validateBonus();\n    valid &= (!!selectedCompany);\n    $button.prop('disabled', !valid);\n  }\n  function validateSalary() {\n    valid = true;\n    if (parseAsNumber($salaryInput.val()) !== false) {\n      // Salary is ok.\n      $form.find('.etgpg__salary_msg').empty();\n    }\n    else {\n      valid = false;\n      $form.find('.etgpg__salary_msg').text('Enter gross salary like 20000');\n    }\n    return valid;\n  }\n  function validateBonus() {\n    valid = true;\n    if (parseAsNumber($bonusInput.val(), true) !== false) {\n      // Bonus is ok.\n      $form.find('.etgpg__bonus_msg').empty();\n    }\n    else {\n      valid = false;\n      $form.find('.etgpg__bonus_msg').text('Enter gross bonus like 20000');\n    }\n    return valid;\n  }\n  function selectCompany() {\n    console.log(\"selectCompany\", hintIndex, hints[hintIndex]);\n    $companyInput.val(hints[hintIndex].name);\n    selectedCompany = hints[hintIndex];\n    $hints.hide();\n    validateForm();\n  }\n  function highlightCompany() {\n    $hints.find('li.highlighted').removeClass('highlighted');\n    if (hintIndex>-1) {\n      $hints.find('li').eq(hintIndex).addClass('highlighted');\n    }\n  }\n  function handleKeyUp(e) {\n    if (e.keyCode == 13) {\n      if (hintIndex < 0) {\n        // Cannot submit.\n\n      }\n      else {\n        selectCompany();\n        // Select hint.\n        // @todo trigger save.\n        // @todo update lifetime loss.\n      }\n    }\n    else if (e.keyCode == 38) {\n      hintIndex--;\n      if (hintIndex <0) {\n        hintIndex = hints.length - 1;\n      }\n      highlightCompany();\n    }\n    else if (e.keyCode == 40) {\n      hintIndex++;\n      if (hintIndex >= hints.length) {\n        hintIndex--;\n      }\n      highlightCompany();\n    }\n    else {\n      if (debounce) {\n        window.clearTimeout(debounce);\n        debounce = false;\n      }\n      if ($companyInput.val().replace(/^\\s*(.*?)\\s*$/, '$1')) {\n        debounce = window.setTimeout(getMatches, 150);\n      }\n      else {\n        hints = [];\n        hintIndex = -1;\n        highlightCompany();\n      }\n    }\n  }\n  function getMatches() {\n    $.getJSON('/etgenderpaygap/matches', { company: $companyInput.val() })\n    .done(json => {\n      console.log(\"matches\", json);\n      hints = json.matches;\n      hintCount = json.count;\n      createHints();\n    })\n    .fail((jqxhr, textStatus, error) => {\n      var err = textStatus + \", \" + error;\n      console.log( \"Request Failed: \" + err );\n    });\n  }\n  function createHints() {\n\n    if (hintCount === 0) {\n      // No hints, provide a fallback.\n      hints = [{name: '(Other UK company, use average)', id: 0}];\n    }\n    const $ul = $('<ul/>');\n\n    hints.forEach((hint, i) => {\n      const $li = $('<li/>')\n        .text(hint.name);\n      $li.on('click', e => { console.log(\"hintIndex set to \", i); hintIndex = i; highlightCompany(); selectCompany(); });\n      $ul.append($li);\n    });\n    hintIndex = 0;\n    $hints.empty().append($ul);\n    $hints.fadeIn('fast');\n\n    highlightCompany();\n  }\n\n  $companyInput\n    .on('keyup', handleKeyUp)\n    .on('blur', e => $hints.fadeOut('fast'));\n\n\n}))(jQuery);\n"]}